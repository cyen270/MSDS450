---
title: "MSDS 450 - Assignment 5"
author: "Calvin Yen, Vivian Jiang, Saud Khan, Nikhila Vudattu"
date: "2/24/2022"
output: 
  html_document:
    toc: true
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
library(bayesm)
library(dummies)
library(pROC)
library(ggplot2)

setwd("~/Calvin/Education/Northwestern/MSDS 450/Assignment 5")
load('stc-cbc-respondents-v3(1).RData')
load('efCode.RData')

cbc_data <- read.csv('stc-dc-task-cbc -v3(1).csv', header=TRUE, sep='\t')
test_scenarios <- read.csv('extra-scenarios(1).csv', header=TRUE, sep=',')
```

## Assignment 5 - CBC Analysis for Star Technologies

### Data Preparation

Start by effects coding dummy data. 

```{r effects_coding}
# Function to effects code an attribute matrix

effects_code <- function(attr_mat) {
  num_attr <- ncol(attr_mat)
  ef_attr_mat <- matrix(data=NA, nrow=nrow(attr_mat), ncol=1)
  for (i in 1:num_attr) {
    attr <- attr_mat[, i]
    dc_attr <- dummy(attr)
    ref_levels <- dc_attr[, 1]
    dc_attr <- dc_attr[, -1]
    if (!is.matrix(dc_attr)) {
      dc_attr <- matrix(dc_attr, ncol=1)
    }
    dc_attr[ref_levels==1, ] <- -1
    ef_attr_mat <- cbind(ef_attr_mat, dc_attr)
  }
  ef_attr_mat <- ef_attr_mat[, -1]
  colnames(ef_attr_mat) <- NULL
  return(ef_attr_mat)
}

```

Add interactions terms for brand and price. 

```{r dataprep}
profiles <- cbc_data[, c('screen', 'RAM', 'processor', 'price', 'brand')]
X.mat <- effects_code(profiles)

pricevec <- cbc_data$price - mean(cbc_data$price)
X.brands <- X.mat[, 9:11]
X.BrandByPrice <- X.brands * pricevec

X.matrix <- cbind(X.mat, X.BrandByPrice)


ydata <- resp.data.v3[, 4:39]
colnames(ydata)
ydata <- na.omit(ydata)
ydata <- as.matrix(ydata)

# Indicator of whether respondent has owned an STC product
zowner <- as.numeric(!is.na(resp.data.v3$vList3))


# Prepare data for hierarchical Bayes model
lgtdata <- NULL
for (i in 1:nrow(ydata)) {
  lgtdata[[i]] <- list(y=ydata[i,], X=X.matrix)
}

```

### Fitting the Hierarchical Bayes Model without a covariate

```{r model1}
# Fit model with first 100 respondents as a test run
lgtdata100 <- lgtdata[1:100]
mcmctest <- list(R=5000, keep=5)

Data1 <- list(p=3, lgtdata=lgtdata100)

testrun1 <- rhierMnlDP(Data=Data1, Mcmc=mcmctest)

# Get the sampled coefficient values
betadraw1 <- testrun1$betadraw
plot(density(betadraw1[1,1,901:1000]), width=1)

summary(betadraw1[1,1,901:100])

# Average coefficient values
apply(betadraw1[,,901:1000], 2, mean)

# Percentiles for coefficient values
apply(betadraw1[,,901:1000], 2, quantile, probs=c(0.05, 0.25, 0.5, 0.75, 0.95))

```

### Fitting the Hierarchical Bayes Model with a covariate
```{r model2}

# Fit model with first 100 respondents as a test run

zownertest <- matrix(scale(zowner[1:100], scale=FALSE), ncol=1)

Data2 <- list(p=3, lgtdata=lgtdata100, Z=zownertest)

testrun2 <- rhierMnlDP(Data=Data2, Mcmc=mcmctest)

# Get the sampled coefficient values
Deltadraw <- testrun2$Deltadraw

# Average coefficient values
apply(Deltadraw[901:1000, ], 2, mean)

# Percentiles for coefficient values
apply(Deltadraw[901:1000, ], 2, quantile, probs=c(0.05, 0.25, 0.5, 0.75, 0.95))

```

### Evaluating Model

Models with and without the covariate performed similarly--AUC scores hovered around a range of 0.85 to 0.86. 

```{r prediction}
##### EVALUATE MODEL WITH COVARIATE #####
betameans2 <- apply(testrun2$betadraw[,,701:1000], c(1,2), mean)

# Multiply product choice sets by respondent coefficients
xbeta <- X.matrix %*% t(betameans2)
xbeta2 <- matrix(xbeta, ncol=3, byrow=TRUE)


# Find probability of selecting each choice with softmax function
expxbeta2 <- exp(xbeta2)
rsumvec <- rowSums(expxbeta2)
pchoicemat <- expxbeta2 / rsumvec
custchoice <- max.col(pchoicemat)

# Evaluate predictions - confusion matrix
ydatavec <- as.vector(t(ydata[1:100, ]))
table(custchoice, ydatavec)

# Confusion matrix
conf_mat <- data.frame(table(custchoice, ydatavec))
ggplot(conf_mat, aes(x=custchoice, y=ydatavec, fill=Freq)) +
  geom_tile() +
  scale_fill_gradient(low='white', high='blue') +
  labs(title='Model with Covariate - Confusion Matrix',
       x='Predicted Profile', 
       y='Actual Profile')

# Plot ROC curve
roctest <- roc(ydatavec, custchoice, plot=TRUE)
auc(roctest)

##### EVALUATE MODEL WITHOUT COVARIATE #####
betameans1 <- apply(testrun1$betadraw[,,701:1000], c(1,2), mean)

# Multiply product choice sets by respondent coefficients
xbeta <- X.matrix %*% t(betameans1)
xbeta2 <- matrix(xbeta, ncol=3, byrow=TRUE)


# Find probability of selecting each choice with softmax function
expxbeta2 <- exp(xbeta2)
rsumvec <- rowSums(expxbeta2)
pchoicemat <- expxbeta2 / rsumvec
custchoice <- max.col(pchoicemat)

# Evaluate predictions - confusion matrix
ydatavec <- as.vector(t(ydata[1:100, ]))
table(custchoice, ydatavec)

# Confusion matrix
conf_mat <- data.frame(table(custchoice, ydatavec))
ggplot(conf_mat, aes(x=custchoice, y=ydatavec, fill=Freq)) +
  geom_tile() +
  scale_fill_gradient(low='white', high='blue') +
  labs(title='Model without Covariate - Confusion Matrix',
       x='Predicted Profile', 
       y='Actual Profile')

# Plot ROC curve
roctest <- roc(ydatavec, custchoice, plot=TRUE)
auc(roctest)

```

### Predicting the additional scenarios

```{r prediction_extra}
# Get average coefficient values across all respondents
betameansoverall <- apply(testrun2$betadraw[,,701:1000], 2, mean)

Xextra.matrix <- as.matrix(test_scenarios[,c("V1","V2","V3","V4","V5","V6","V7","V8","V9",
                                            "V10","V11","V12","V13","V14")])

betavec <- matrix(betameansoverall, ncol=1, byrow=TRUE)

# Derive utilities for each profile
xextrabeta <- Xextra.matrix %*% betavec
xextrabeta2 <- matrix(xextrabeta, ncol=3, byrow=TRUE)

# Derive probabilities of choosing each profile
expxbetaextra2 <- exp(xextrabeta2)
rsumvec <- rowSums(expxbetaextra2)
pchoicemat <- expxbetaextra2/rsumvec
pchoicemat




```
